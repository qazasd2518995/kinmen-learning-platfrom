<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>模擬市場 - 金聲玉語</title>
  <link rel="icon" type="image/png" href="favicon.png">
  <link rel="apple-touch-icon" href="apple-touch-icon.png">
  <meta name="description" content="金門話模擬市場：角色扮演買菜練習">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;600;700&family=Noto+Serif+TC:wght@500;600;700;900&display=swap" rel="stylesheet">

  <style>
    :root {
      /* Dashboard 變數 */
      --header-height: 56px;
      --content-height: calc(100dvh - var(--header-height) - 8px);
      --dashboard-gap: 1rem;

      /* 動態字體 */
      --h1-size: clamp(1.5rem, 3vw, 2.5rem);
      --h2-size: clamp(1.25rem, 2.5vw, 2rem);
      --body-size: clamp(0.875rem, 1.2vw, 1rem);

      /* 原有變數 */
      --kinmen-gold: #D4A84B;
      --kinmen-gold-light: #F5E6C8;
      --kinmen-gold-dark: #8B6914;
      --kinmen-red: #C84B31;
      --kinmen-red-light: #E8B4A8;
      --kinmen-ocean: #5B8FA8;
      --kinmen-ocean-light: #C5DDE8;
      --kinmen-green: #7D9D6D;
      --kinmen-green-light: #D4E5CC;
      --bg-primary: #FDF6F0;
      --bg-secondary: #F5E8E0;
      --bg-card: #FFFFFF;
      --text-primary: #3D3229;
      --text-secondary: #6B5D52;
      --text-accent: #8B6914;
      --deco-brick: #B85A4A;
      --shadow-sm: 0 2px 8px rgba(61, 50, 41, 0.08);
      --shadow-md: 0 4px 16px rgba(61, 50, 41, 0.12);
      --shadow-lg: 0 8px 32px rgba(61, 50, 41, 0.16);
      --shadow-xl: 0 12px 48px rgba(61, 50, 41, 0.2);
      --shadow-lift-sm: 0 4px 12px rgba(61, 50, 41, 0.15);
      --shadow-lift-md: 0 8px 24px rgba(61, 50, 41, 0.18);
      --glow-gold: 0 0 20px rgba(212, 168, 75, 0.3);
      --glow-ocean: 0 0 20px rgba(91, 143, 168, 0.3);
      --glow-green: 0 0 20px rgba(125, 157, 109, 0.3);
      --duration-fast: 150ms;
      --duration-normal: 250ms;
      --duration-slow: 400ms;
      --duration-slower: 600ms;
      --spring: cubic-bezier(0.34, 1.56, 0.64, 1);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 20px;
      --radius-xl: 32px;
      --font-display: 'Noto Serif TC', serif;
      --font-body: 'Noto Sans TC', sans-serif;
      --ease-out: cubic-bezier(0.16, 1, 0.3, 1);
    }

    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
    html { font-size: 16px; }
    body {
      font-family: var(--font-body);
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.6;
      min-height: 100vh;
    }
    button { font-family: inherit; border: none; background: none; cursor: pointer; }
    a { text-decoration: none; color: inherit; }

    /* 全域觸控優化 */
    button, [role="button"], .interactive, a, .stall-item, .response-option, .shopping-item {
      touch-action: manipulation;
    }

    /* 輸入框防 iOS 縮放 */
    input, textarea, select {
      font-size: max(16px, 1rem);
    }

    /* 觸控目標標準 */
    :root {
      --touch-target-min: 44px;
      --touch-target-comfortable: 48px;
      --touch-spacing-min: 8px;
    }

    /* 背景 */
    .bg-pattern {
      position: fixed; inset: 0; pointer-events: none; z-index: 0; opacity: 0.08;
      background-image:
        repeating-linear-gradient(45deg, var(--deco-brick) 0, var(--deco-brick) 2px, transparent 2px, transparent 20px),
        repeating-linear-gradient(-45deg, var(--deco-brick) 0, var(--deco-brick) 2px, transparent 2px, transparent 20px);
    }
    .bg-gradient {
      position: fixed; inset: 0; pointer-events: none; z-index: 0;
      background:
        radial-gradient(ellipse 80% 50% at 20% 0%, rgba(212, 168, 75, 0.15) 0%, transparent 50%),
        radial-gradient(ellipse 60% 40% at 80% 100%, rgba(91, 143, 168, 0.1) 0%, transparent 50%);
    }
    .roof-deco {
      position: fixed; top: 0; left: 0; right: 0; height: 8px;
      background: linear-gradient(90deg, var(--kinmen-gold) 0%, var(--kinmen-red) 25%, var(--kinmen-gold) 50%, var(--kinmen-red) 75%, var(--kinmen-gold) 100%);
      z-index: 100;
    }

    /* 頂部導航 */
    .nav-header {
      position: sticky; top: 8px; z-index: 50;
      display: flex; align-items: center; justify-content: space-between;
      padding: 12px 24px;
      background: rgba(253, 246, 240, 0.9);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(139, 105, 20, 0.1);
    }
    .nav-left { display: flex; align-items: center; gap: 16px; }
    .back-btn {
      display: flex; align-items: center; gap: 8px;
      padding: 8px 16px; border-radius: var(--radius-md);
      color: var(--text-secondary); font-weight: 500;
      transition: all 0.25s var(--ease-out);
    }
    .back-btn:hover { background: var(--bg-secondary); color: var(--text-primary); }
    .back-btn svg { width: 20px; height: 20px; }
    .page-title {
      font-family: var(--font-display);
      font-size: 1.25rem; font-weight: 700;
      color: var(--text-accent);
    }

    /* 主內容 */
    main {
      position: relative; z-index: 1;
      max-width: 900px; margin: 0 auto;
      padding: 24px;
    }

    /* 介紹區 */
    .intro-section {
      background: var(--bg-card);
      border-radius: var(--radius-xl);
      padding: 32px;
      margin-bottom: 24px;
      box-shadow: var(--shadow-md);
      text-align: center;
      position: relative;
      overflow: hidden;
      border: 1px solid rgba(139, 105, 20, 0.1);
    }

    .intro-section::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 5px;
      background: linear-gradient(90deg, var(--kinmen-gold) 0%, var(--kinmen-red) 50%, var(--kinmen-gold) 100%);
    }

    .intro-title {
      font-family: var(--font-display);
      font-size: 2rem;
      color: var(--text-accent);
      margin-bottom: 16px;
      position: relative;
      display: inline-block;
    }

    .intro-title::after {
      content: '';
      position: absolute;
      bottom: -4px;
      left: 50%;
      transform: translateX(-50%);
      width: 60px;
      height: 3px;
      background: var(--kinmen-gold);
      border-radius: 2px;
    }

    /* 介紹副標題 */
    .intro-subtitle {
      font-size: 1.125rem;
      color: var(--text-secondary);
      margin-bottom: 32px;
      max-width: 500px;
      margin-left: auto;
      margin-right: auto;
    }

    /* 市場情境圖示區 */
    .market-scene {
      display: flex;
      justify-content: center;
      gap: 24px;
      margin-bottom: 32px;
      flex-wrap: wrap;
    }

    .scene-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      padding: 16px 20px;
      background: linear-gradient(145deg, var(--bg-secondary) 0%, var(--kinmen-gold-light) 100%);
      border-radius: var(--radius-lg);
      transition: all var(--duration-normal) var(--ease-out);
      border: 2px solid transparent;
    }

    .scene-item:hover {
      transform: translateY(-4px);
      border-color: var(--kinmen-gold);
      box-shadow: var(--shadow-md), var(--glow-gold);
    }

    .scene-icon {
      width: 60px;
      height: 60px;
      background: linear-gradient(135deg, var(--kinmen-gold) 0%, var(--kinmen-gold-dark) 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: var(--shadow-md);
    }

    .scene-icon svg {
      width: 28px;
      height: 28px;
      stroke: white;
      fill: none;
      stroke-width: 2;
      stroke-linecap: round;
      stroke-linejoin: round;
    }

    .scene-label {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--text-accent);
    }

    /* 步驟區標題 */
    .steps-header {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      margin-bottom: 20px;
      font-family: var(--font-display);
      font-size: 1.25rem;
      color: var(--text-accent);
    }

    .steps-header::before,
    .steps-header::after {
      content: '';
      width: 40px;
      height: 2px;
      background: linear-gradient(90deg, transparent, var(--kinmen-gold));
    }

    .steps-header::after {
      background: linear-gradient(90deg, var(--kinmen-gold), transparent);
    }

    .intro-steps {
      text-align: left;
      max-width: 700px;
      margin: 0 auto;
      display: grid;
      gap: 16px;
    }

    .intro-step {
      display: flex;
      gap: 16px;
      padding: 20px 24px;
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      transition: all var(--duration-normal) var(--ease-out);
      border: 2px solid var(--bg-secondary);
      position: relative;
      overflow: hidden;
      box-shadow: var(--shadow-sm);
    }

    .intro-step::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 4px;
      background: linear-gradient(180deg, var(--kinmen-gold) 0%, var(--kinmen-gold-dark) 100%);
      transform: scaleY(0);
      transition: transform var(--duration-normal) var(--ease-out);
    }

    .intro-step:hover {
      background: var(--kinmen-gold-light);
      border-color: var(--kinmen-gold);
      transform: translateX(8px);
      box-shadow: var(--shadow-md), var(--glow-gold);
    }

    .intro-step:hover::before {
      transform: scaleY(1);
    }

    .step-icon-wrap {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }

    .step-number {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, var(--kinmen-gold) 0%, var(--kinmen-gold-dark) 100%);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 1.125rem;
      flex-shrink: 0;
      box-shadow: var(--shadow-md);
    }

    .step-icon {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .step-icon svg {
      width: 24px;
      height: 24px;
      stroke: var(--kinmen-gold-dark);
      fill: none;
      stroke-width: 2;
      stroke-linecap: round;
      stroke-linejoin: round;
    }

    .step-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .step-text {
      font-weight: 600;
      color: var(--text-primary);
      font-size: 1rem;
      margin-bottom: 4px;
    }

    .step-desc {
      font-size: 0.875rem;
      color: var(--text-secondary);
    }

    /* 提示區 */
    .intro-tips {
      display: flex;
      justify-content: center;
      gap: 16px;
      margin-top: 32px;
      margin-bottom: 24px;
      flex-wrap: wrap;
    }

    .tip-badge {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 18px;
      background: linear-gradient(135deg, var(--kinmen-ocean-light) 0%, var(--kinmen-ocean) 20%, var(--kinmen-ocean-light) 100%);
      border-radius: 100px;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--text-primary);
      border: 1px solid rgba(91, 143, 168, 0.3);
      box-shadow: var(--shadow-sm);
    }

    .tip-badge svg {
      width: 18px;
      height: 18px;
      stroke: var(--kinmen-ocean);
      fill: none;
      stroke-width: 2;
      stroke-linecap: round;
      stroke-linejoin: round;
      flex-shrink: 0;
    }

    .start-btn {
      margin-top: 24px;
      padding: 16px 48px;
      background: linear-gradient(135deg, var(--kinmen-gold) 0%, var(--kinmen-gold-dark) 100%);
      color: white;
      font-size: 1.125rem;
      font-weight: 600;
      border-radius: var(--radius-md);
      transition: all var(--duration-normal) var(--ease-out);
      position: relative;
      overflow: hidden;
      box-shadow: var(--shadow-md);
    }

    .start-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      transition: left var(--duration-slow) ease;
    }

    .start-btn:hover {
      transform: translateY(-3px);
      box-shadow: var(--shadow-lg), var(--glow-gold);
    }

    .start-btn:hover::before {
      left: 100%;
    }

    .start-btn:active {
      transform: translateY(-1px) scale(0.98);
    }

    /* 購物清單 */
    .shopping-section {
      display: none;
    }

    .shopping-section.active {
      display: block;
      animation: fadeIn 0.5s var(--ease-out);
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .shopping-header {
      background: var(--bg-card);
      border-radius: var(--radius-xl);
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: var(--shadow-md);
      position: relative;
      overflow: hidden;
      border: 1px solid rgba(139, 105, 20, 0.1);
    }

    .shopping-header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--kinmen-green) 0%, var(--kinmen-gold) 100%);
    }

    .shopping-title {
      font-family: var(--font-display);
      font-size: 1.5rem;
      color: var(--text-accent);
      margin-bottom: 16px;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .shopping-title::before {
      content: '';
      display: inline-block;
      width: 24px;
      height: 24px;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%238B6914' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2'/%3E%3Crect x='8' y='2' width='8' height='4' rx='1' ry='1'/%3E%3C/svg%3E");
      background-size: contain;
    }

    .shopping-list {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: center;
    }

    .shopping-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 20px;
      background: var(--bg-secondary);
      border-radius: var(--radius-md);
      font-weight: 500;
      transition: all var(--duration-normal) var(--ease-out);
      border: 2px solid transparent;
      position: relative;
    }

    .shopping-item.bought {
      background: var(--kinmen-green-light);
      border-color: var(--kinmen-green);
      animation: itemBought 0.5s var(--spring);
    }

    .shopping-item.bought::after {
      content: '✓';
      position: absolute;
      top: -8px;
      right: -8px;
      width: 24px;
      height: 24px;
      background: var(--kinmen-green);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: 700;
      box-shadow: var(--shadow-sm);
      animation: checkPop 0.4s var(--spring);
    }

    @keyframes itemBought {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    @keyframes checkPop {
      0% { transform: scale(0); opacity: 0; }
      100% { transform: scale(1); opacity: 1; }
    }

    .shopping-item-qty {
      background: linear-gradient(135deg, var(--kinmen-gold) 0%, var(--kinmen-gold-dark) 100%);
      color: white;
      padding: 2px 10px;
      border-radius: 100px;
      font-size: 0.875rem;
      box-shadow: var(--shadow-sm);
    }

    /* 市場攤位 */
    .market-area {
      background: var(--bg-card);
      border-radius: var(--radius-xl);
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: var(--shadow-md);
      position: relative;
      overflow: hidden;
      border: 1px solid rgba(139, 105, 20, 0.1);
    }

    .market-area::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--kinmen-red) 0%, var(--kinmen-gold) 50%, var(--kinmen-red) 100%);
    }

    .market-title {
      font-family: var(--font-display);
      font-size: 1.25rem;
      color: var(--text-accent);
      margin-bottom: 16px;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .market-title::before {
      content: '';
      display: inline-block;
      width: 22px;
      height: 22px;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%238B6914' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='m2 7 4.41-4.41A2 2 0 0 1 7.83 2h8.34a2 2 0 0 1 1.42.59L22 7'/%3E%3Cpath d='M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8'/%3E%3Cpath d='M15 22v-4a2 2 0 0 0-2-2h-2a2 2 0 0 0-2 2v4'/%3E%3Cpath d='M2 7h20'/%3E%3Cpath d='M22 7v3a2 2 0 0 1-2 2v0a2.7 2.7 0 0 1-1.59-.63.7.7 0 0 0-.82 0A2.7 2.7 0 0 1 16 12a2.7 2.7 0 0 1-1.59-.63.7.7 0 0 0-.82 0A2.7 2.7 0 0 1 12 12a2.7 2.7 0 0 1-1.59-.63.7.7 0 0 0-.82 0A2.7 2.7 0 0 1 8 12a2.7 2.7 0 0 1-1.59-.63.7.7 0 0 0-.82 0A2.7 2.7 0 0 1 4 12v0a2 2 0 0 1-2-2V7'/%3E%3C/svg%3E");
      background-size: contain;
    }

    .stall-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 16px;
    }

    .stall-item {
      background: var(--bg-secondary);
      border-radius: var(--radius-lg);
      padding: 16px;
      text-align: center;
      cursor: pointer;
      transition: all var(--duration-normal) var(--ease-out);
      border: 2px solid transparent;
      position: relative;
      overflow: hidden;
    }

    .stall-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--kinmen-gold);
      transform: scaleX(0);
      transition: transform var(--duration-normal) var(--ease-out);
    }

    .stall-item:hover {
      transform: translateY(-6px);
      box-shadow: var(--shadow-lg), var(--glow-gold);
      border-color: var(--kinmen-gold-light);
    }

    .stall-item:hover::before {
      transform: scaleX(1);
    }

    .stall-item:active {
      transform: translateY(-2px) scale(0.98);
    }

    .stall-item.selected {
      border-color: var(--kinmen-gold);
      background: var(--kinmen-gold-light);
      box-shadow: var(--shadow-md), var(--glow-gold);
    }

    .stall-item.selected::before {
      transform: scaleX(1);
    }

    .stall-image {
      width: 80px;
      height: 80px;
      margin: 0 auto 8px;
      background: var(--bg-card);
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.5rem;
      box-shadow: var(--shadow-sm);
      transition: all var(--duration-normal) var(--ease-out);
      overflow: hidden;
    }

    .stall-image img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      border-radius: 0;
    }

    .stall-item:hover .stall-image {
      transform: scale(1.05);
      box-shadow: var(--shadow-md);
    }

    .stall-name {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .stall-price {
      font-size: 0.875rem;
      color: var(--kinmen-red);
      font-weight: 500;
      padding: 4px 12px;
      background: rgba(200, 75, 49, 0.1);
      border-radius: 100px;
      display: inline-block;
    }

    /* 對話區 */
    .dialogue-area {
      background: var(--bg-card);
      border-radius: var(--radius-xl);
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: var(--shadow-md);
      display: none;
      position: relative;
      overflow: hidden;
      border: 1px solid rgba(139, 105, 20, 0.1);
    }

    .dialogue-area::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--kinmen-ocean) 0%, var(--kinmen-gold) 100%);
    }

    .dialogue-area.active {
      display: block;
      animation: fadeIn 0.4s var(--ease-out);
    }

    .dialogue-header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 2px solid var(--bg-secondary);
    }

    .dialogue-avatar {
      width: 60px;
      height: 60px;
      background: linear-gradient(135deg, var(--kinmen-gold-light) 0%, var(--kinmen-gold) 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: var(--font-display);
      font-size: 1.25rem;
      font-weight: 700;
      color: white;
      box-shadow: var(--shadow-md);
      text-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }

    .dialogue-info h3 {
      font-family: var(--font-display);
      color: var(--text-accent);
      font-size: 1.25rem;
    }

    .dialogue-info p {
      font-size: 0.875rem;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .dialogue-info p::before {
      content: '';
      display: inline-block;
      width: 18px;
      height: 18px;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%236B5D52' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='9' cy='21' r='1'/%3E%3Ccircle cx='20' cy='21' r='1'/%3E%3Cpath d='M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6'/%3E%3C/svg%3E");
      background-size: contain;
      vertical-align: middle;
    }

    .dialogue-messages {
      max-height: 300px;
      overflow-y: auto;
      padding: 20px;
      background: linear-gradient(180deg, var(--bg-secondary) 0%, rgba(245, 232, 224, 0.5) 100%);
      border-radius: var(--radius-md);
      margin-bottom: 20px;
      border: 1px solid rgba(139, 105, 20, 0.1);
    }

    .message {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
      animation: slideIn 0.3s var(--ease-out);
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateX(-20px); }
      to { opacity: 1; transform: translateX(0); }
    }

    @keyframes slideInRight {
      from { opacity: 0; transform: translateX(20px); }
      to { opacity: 1; transform: translateX(0); }
    }

    .message.customer {
      flex-direction: row-reverse;
      animation: slideInRight 0.3s var(--ease-out);
    }

    .message-avatar {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, var(--kinmen-gold-light) 0%, var(--kinmen-gold) 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: var(--font-display);
      font-size: 0.875rem;
      font-weight: 700;
      color: white;
      flex-shrink: 0;
      box-shadow: var(--shadow-sm);
    }

    .message.customer .message-avatar {
      background: linear-gradient(135deg, var(--kinmen-ocean-light) 0%, var(--kinmen-ocean) 100%);
    }

    .message-content {
      max-width: 70%;
      position: relative;
    }

    .message-bubble {
      padding: 12px 16px;
      background: var(--bg-card);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-sm);
      position: relative;
      border: 1px solid rgba(139, 105, 20, 0.08);
    }

    /* 賣家氣泡左尖角 */
    .message:not(.customer) .message-bubble::before {
      content: '';
      position: absolute;
      left: -8px;
      top: 14px;
      width: 0;
      height: 0;
      border-top: 8px solid transparent;
      border-bottom: 8px solid transparent;
      border-right: 8px solid var(--bg-card);
      filter: drop-shadow(-2px 0 1px rgba(61, 50, 41, 0.05));
    }

    .message.customer .message-bubble {
      background: var(--kinmen-ocean-light);
      border-color: rgba(91, 143, 168, 0.2);
    }

    /* 顧客氣泡右尖角 */
    .message.customer .message-bubble::after {
      content: '';
      position: absolute;
      right: -8px;
      top: 14px;
      width: 0;
      height: 0;
      border-top: 8px solid transparent;
      border-bottom: 8px solid transparent;
      border-left: 8px solid var(--kinmen-ocean-light);
      filter: drop-shadow(2px 0 1px rgba(61, 50, 41, 0.05));
    }

    .message-text {
      font-weight: 500;
      margin-bottom: 4px;
    }

    .message-pinyin {
      font-size: 0.8125rem;
      color: var(--text-secondary);
      font-style: italic;
    }

    .message-audio {
      margin-top: 8px;
      padding: 6px 12px;
      background: var(--bg-secondary);
      border-radius: var(--radius-sm);
      font-size: 0.75rem;
      color: var(--text-secondary);
      display: inline-flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
      transition: all var(--duration-fast);
    }

    .message-audio:hover {
      background: var(--kinmen-gold-light);
      color: var(--text-accent);
    }

    /* 回應選項 */
    .response-options {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .response-option {
      padding: 16px 20px;
      background: var(--bg-secondary);
      border-radius: var(--radius-md);
      text-align: left;
      transition: all var(--duration-normal) var(--ease-out);
      border: 2px solid rgba(91, 143, 168, 0.2);
      position: relative;
      overflow: hidden;
      min-height: var(--touch-target-comfortable);
    }

    .response-option::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 4px;
      background: var(--kinmen-ocean);
      transform: scaleY(0);
      transition: transform var(--duration-normal) var(--ease-out);
    }

    .response-option::after {
      content: '';
      position: absolute;
      right: 16px;
      top: 50%;
      width: 20px;
      height: 20px;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%235B8FA8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='m3 21 1.9-5.7a8.5 8.5 0 1 1 3.8 3.8z'/%3E%3C/svg%3E");
      background-size: contain;
      transform: translateY(-50%) scale(0.8);
      opacity: 0;
      transition: all var(--duration-normal) var(--ease-out);
    }

    .response-option:hover {
      background: var(--kinmen-ocean-light);
      border-color: var(--kinmen-ocean);
      transform: translateX(8px);
      box-shadow: var(--shadow-md), var(--glow-ocean);
      padding-right: 48px;
    }

    .response-option:hover::before {
      transform: scaleY(1);
    }

    .response-option:hover::after {
      opacity: 1;
      transform: translateY(-50%) scale(1);
    }

    .response-option:active {
      transform: translateX(4px) scale(0.98);
    }

    .response-chinese {
      font-weight: 600;
      margin-bottom: 4px;
      color: var(--text-primary);
    }

    .response-pinyin {
      font-size: 0.875rem;
      color: var(--text-secondary);
      font-style: italic;
    }

    /* 結帳區 */
    .checkout-area {
      background: var(--bg-card);
      border-radius: var(--radius-xl);
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: var(--shadow-md);
      display: none;
      position: relative;
      overflow: hidden;
      border: 1px solid rgba(139, 105, 20, 0.1);
    }

    .checkout-area::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--kinmen-green) 0%, var(--kinmen-gold) 100%);
    }

    .checkout-area.active {
      display: block;
      animation: fadeIn 0.4s var(--ease-out);
    }

    .checkout-title {
      font-family: var(--font-display);
      font-size: 1.25rem;
      color: var(--text-accent);
      margin-bottom: 16px;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .checkout-title::before {
      content: '';
      display: inline-block;
      width: 22px;
      height: 22px;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%238B6914' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M4 2v20l2-1 2 1 2-1 2 1 2-1 2 1 2-1 2 1V2l-2 1-2-1-2 1-2-1-2 1-2-1-2 1Z'/%3E%3Cpath d='M16 8h-6a2 2 0 1 0 0 4h4a2 2 0 1 1 0 4H8'/%3E%3Cpath d='M12 17.5v-11'/%3E%3C/svg%3E");
      background-size: contain;
    }

    .checkout-items {
      margin-bottom: 20px;
    }

    .checkout-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 16px;
      background: var(--bg-secondary);
      border-radius: var(--radius-sm);
      margin-bottom: 8px;
      border-left: 3px solid var(--kinmen-gold);
      transition: all var(--duration-fast);
      min-height: var(--touch-target-min);
    }

    .checkout-item:hover {
      background: var(--kinmen-gold-light);
      transform: translateX(4px);
    }

    .checkout-total {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 24px;
      background: linear-gradient(135deg, var(--kinmen-gold-light) 0%, var(--kinmen-gold) 100%);
      border-radius: var(--radius-md);
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-primary);
      box-shadow: var(--shadow-md), var(--glow-gold);
      border: 2px solid var(--kinmen-gold);
      position: relative;
      overflow: hidden;
    }

    .checkout-total::before {
      content: '';
      position: absolute;
      right: 20px;
      top: 50%;
      width: 40px;
      height: 40px;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%238B6914' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='12' cy='12' r='10'/%3E%3Cpath d='M16 8h-6a2 2 0 1 0 0 4h4a2 2 0 1 1 0 4H8'/%3E%3Cpath d='M12 18V6'/%3E%3C/svg%3E");
      background-size: contain;
      transform: translateY(-50%);
      opacity: 0.3;
    }

    .checkout-total span:last-child {
      font-size: 1.75rem;
      color: var(--kinmen-gold-dark);
      text-shadow: 0 1px 2px rgba(255,255,255,0.5);
    }

    .pay-btn {
      width: 100%;
      margin-top: 20px;
      padding: 18px;
      background: linear-gradient(135deg, var(--kinmen-green) 0%, #5A8A4A 100%);
      color: white;
      font-size: 1.125rem;
      font-weight: 600;
      border-radius: var(--radius-md);
      transition: all var(--duration-normal) var(--ease-out);
      position: relative;
      overflow: hidden;
      box-shadow: var(--shadow-md);
    }

    .pay-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.25), transparent);
      transition: left var(--duration-slow) ease;
    }

    .pay-btn:hover {
      transform: translateY(-3px);
      box-shadow: var(--shadow-lg), var(--glow-green);
    }

    .pay-btn:hover::before {
      left: 100%;
    }

    .pay-btn:active {
      transform: translateY(-1px) scale(0.98);
    }

    /* 完成畫面 */
    .complete-section {
      display: none;
    }

    .complete-section.active {
      display: block;
      animation: fadeIn 0.5s var(--ease-out);
    }

    .complete-card {
      background: linear-gradient(180deg, var(--bg-card) 0%, var(--kinmen-green-light) 100%);
      border-radius: var(--radius-xl);
      padding: 48px;
      text-align: center;
      box-shadow: var(--shadow-lg);
      position: relative;
      overflow: hidden;
      border: 1px solid rgba(125, 157, 109, 0.2);
    }

    .complete-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 5px;
      background: linear-gradient(90deg, var(--kinmen-green) 0%, var(--kinmen-gold) 50%, var(--kinmen-green) 100%);
    }

    .complete-icon {
      width: 100px;
      height: 100px;
      margin: 0 auto 24px;
      background: linear-gradient(135deg, var(--kinmen-green) 0%, #5A8A4A 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: var(--shadow-lg), var(--glow-green);
      animation: iconBounce 0.6s var(--spring);
    }

    @keyframes iconBounce {
      0% { transform: scale(0); opacity: 0; }
      60% { transform: scale(1.2); }
      100% { transform: scale(1); opacity: 1; }
    }

    .complete-icon svg {
      width: 50px;
      height: 50px;
      color: white;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
    }

    .complete-title {
      font-family: var(--font-display);
      font-size: 2rem;
      color: var(--kinmen-green);
      margin-bottom: 16px;
      animation: titleAppear 0.5s var(--ease-out) 0.2s both;
    }

    @keyframes titleAppear {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .complete-message {
      color: var(--text-secondary);
      margin-bottom: 24px;
      font-size: 1.125rem;
      animation: titleAppear 0.5s var(--ease-out) 0.3s both;
    }

    .complete-stats {
      display: flex;
      justify-content: center;
      gap: 32px;
      margin-bottom: 32px;
    }

    .stat-item {
      text-align: center;
      padding: 16px 24px;
      background: var(--bg-card);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-md);
      animation: statAppear 0.5s var(--spring) both;
    }

    .stat-item:nth-child(1) { animation-delay: 0.4s; }
    .stat-item:nth-child(2) { animation-delay: 0.5s; }
    .stat-item:nth-child(3) { animation-delay: 0.6s; }

    @keyframes statAppear {
      from { opacity: 0; transform: translateY(20px) scale(0.9); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }

    .stat-value {
      font-size: 2.25rem;
      font-weight: 700;
      color: var(--kinmen-gold);
      text-shadow: 0 2px 4px rgba(212, 168, 75, 0.2);
    }

    .stat-label {
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-top: 4px;
    }

    .restart-btn {
      padding: 16px 48px;
      background: linear-gradient(135deg, var(--kinmen-gold) 0%, var(--kinmen-gold-dark) 100%);
      color: white;
      font-size: 1.125rem;
      font-weight: 600;
      border-radius: var(--radius-md);
      transition: all var(--duration-normal) var(--ease-out);
      position: relative;
      overflow: hidden;
      box-shadow: var(--shadow-md);
      animation: titleAppear 0.5s var(--ease-out) 0.7s both;
    }

    .restart-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      transition: left var(--duration-slow) ease;
    }

    .restart-btn:hover {
      transform: translateY(-3px);
      box-shadow: var(--shadow-lg), var(--glow-gold);
    }

    .restart-btn:hover::before {
      left: 100%;
    }

    .restart-btn:active {
      transform: translateY(-1px) scale(0.98);
    }

    /* ========================================
       響應式 - Desktop Dashboard (>=1200px)
       ======================================== */
    @media (min-width: 1200px) {
      body {
        height: 100vh;
        height: 100dvh;
        overflow: hidden;
      }

      main {
        height: var(--content-height);
        overflow-y: auto;
      }

      /* 介紹區 Dashboard */
      .intro-section {
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 24px;
        overflow-y: auto;
      }

      .intro-title {
        font-size: 2rem;
        margin-bottom: 8px;
      }

      .intro-subtitle {
        font-size: 1rem;
        margin-bottom: 20px;
      }

      .market-scene {
        gap: 16px;
        margin-bottom: 20px;
      }

      .scene-item {
        padding: 12px 16px;
      }

      .scene-icon {
        width: 50px;
        height: 50px;
      }

      .scene-icon svg {
        width: 24px;
        height: 24px;
      }

      .scene-label {
        font-size: 0.8rem;
      }

      .steps-header {
        font-size: 1.125rem;
        margin-bottom: 16px;
      }

      .intro-steps {
        max-width: 700px;
        margin-bottom: 16px;
        gap: 10px;
      }

      .intro-step {
        padding: 14px 18px;
      }

      .step-number {
        width: 32px;
        height: 32px;
        font-size: 0.9rem;
      }

      .step-icon svg {
        width: 20px;
        height: 20px;
      }

      .step-text {
        font-size: 0.9rem;
      }

      .step-desc {
        font-size: 0.8rem;
      }

      .intro-tips {
        margin-top: 16px;
        margin-bottom: 16px;
        gap: 12px;
      }

      .tip-badge {
        padding: 8px 14px;
        font-size: 0.8rem;
      }

      .start-btn {
        padding: 14px 36px;
        font-size: 1rem;
      }

      /* 市場區 - 桌面版垂直佈局 */
      .shopping-section.active {
        display: block;
        height: 100%;
        padding: var(--dashboard-gap);
        overflow-y: auto;
      }

      /* 攤位區域 */
      .stall-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 10px;
        align-content: start;
        overflow-y: auto;
        padding-right: 8px;
        scrollbar-width: thin;
      }

      .stall-grid::-webkit-scrollbar {
        width: 4px;
      }

      .stall-grid::-webkit-scrollbar-track {
        background: transparent;
      }

      .stall-grid::-webkit-scrollbar-thumb {
        background: rgba(139, 105, 20, 0.2);
        border-radius: 2px;
      }

      .stall-card {
        padding: 12px;
      }

      .stall-image {
        width: 50px;
        height: 50px;
        margin-bottom: 8px;
      }

      .stall-name {
        font-size: 0.85rem;
      }

      .stall-info {
        font-size: 0.7rem;
      }

      /* 對話區域 */
      .dialogue-area.active {
        display: block;
      }

      .dialogue-header {
        flex-shrink: 0;
        margin-bottom: 12px;
      }

      .dialogue-content {
        flex: 1;
        overflow-y: auto;
        scrollbar-width: thin;
      }

      .dialogue-input {
        flex-shrink: 0;
        margin-top: 12px;
      }

      /* 購物車區域 */
      .cart-area {
        grid-area: cart;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        padding: 16px;
        background: var(--bg-card);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-md);
      }

      .cart-header {
        flex-shrink: 0;
        margin-bottom: 12px;
      }

      .cart-items {
        flex: 1;
        overflow-y: auto;
        scrollbar-width: thin;
      }

      .cart-total {
        flex-shrink: 0;
        margin-top: 12px;
        padding-top: 12px;
        border-top: 2px dashed rgba(139, 105, 20, 0.15);
      }

      /* 進度區域 */
      .shopping-progress {
        grid-area: progress;
        padding: 12px 20px;
        background: var(--bg-card);
        border-radius: var(--radius-md);
        box-shadow: var(--shadow-sm);
      }

      /* 完成畫面 */
      .complete-section.active {
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 24px;
        overflow: hidden;
      }

      .complete-title {
        font-size: 2rem;
        margin-bottom: 16px;
      }

      .complete-stats {
        margin-bottom: 24px;
      }

      .stat-item {
        padding: 16px 24px;
      }

      .restart-btn {
        padding: 14px 32px;
        font-size: 1rem;
      }
    }

    /* Desktop Large (>=1400px) */
    @media (min-width: 1400px) {
      .stall-card {
        padding: 14px;
      }

      .stall-image {
        width: 60px;
        height: 60px;
      }

      .stall-name {
        font-size: 0.9rem;
      }

      .dialogue-area,
      .cart-area {
        padding: 20px;
      }
    }

    /* Tablet (768px - 1199px) */
    @media (min-width: 768px) and (max-width: 1199px) {
      main {
        padding: 24px;
      }

      .intro-section {
        padding: 24px;
      }

      .stall-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
      }
    }

    /* Mobile (<768px) */
    @media (max-width: 767px) {
      .intro-section {
        padding: 24px 16px;
      }

      .intro-title {
        font-size: 1.75rem;
      }

      .intro-subtitle {
        font-size: 1rem;
        margin-bottom: 24px;
      }

      .market-scene {
        gap: 12px;
        margin-bottom: 24px;
      }

      .scene-item {
        padding: 12px 14px;
        min-width: 70px;
      }

      .scene-icon {
        width: 45px;
        height: 45px;
      }

      .scene-icon svg {
        width: 22px;
        height: 22px;
      }

      .scene-label {
        font-size: 0.75rem;
      }

      .steps-header {
        font-size: 1.125rem;
      }

      .intro-steps {
        gap: 12px;
      }

      .intro-step {
        padding: 16px;
      }

      .step-icon-wrap {
        gap: 6px;
      }

      .step-number {
        width: 36px;
        height: 36px;
        font-size: 1rem;
      }

      .step-icon svg {
        width: 20px;
        height: 20px;
      }

      .step-text {
        font-size: 0.95rem;
      }

      .step-desc {
        font-size: 0.8rem;
      }

      .intro-tips {
        gap: 10px;
        margin-top: 24px;
      }

      .tip-badge {
        padding: 8px 12px;
        font-size: 0.8rem;
      }

      /* 攤位選擇 - 手機版水平滾動 */
      .market-area {
        padding: 16px;
        margin-bottom: 16px;
      }

      .market-title {
        font-size: 1.1rem;
        margin-bottom: 12px;
      }

      .stall-grid {
        display: flex;
        overflow-x: auto;
        gap: 12px;
        padding-bottom: 8px;
        scroll-snap-type: x mandatory;
        -webkit-overflow-scrolling: touch;
      }

      .stall-grid::-webkit-scrollbar {
        height: 4px;
      }

      .stall-grid::-webkit-scrollbar-track {
        background: var(--bg-secondary);
        border-radius: 2px;
      }

      .stall-grid::-webkit-scrollbar-thumb {
        background: var(--kinmen-gold);
        border-radius: 2px;
      }

      .stall-item {
        flex: 0 0 auto;
        width: 110px;
        padding: 12px;
        scroll-snap-align: start;
        min-height: var(--touch-target-min);
      }

      .stall-item .stall-emoji {
        font-size: 1.75rem;
      }

      .stall-item .stall-name {
        font-size: 0.8rem;
      }

      /* 對話區 - 手機版優化 */
      .dialogue-area {
        padding: 16px;
        margin-bottom: 16px;
      }

      .dialogue-area.active {
        /* 顯示時自動滾動到對話區 */
        scroll-margin-top: 70px;
      }

      .dialogue-header {
        gap: 12px;
        margin-bottom: 12px;
        padding-bottom: 12px;
      }

      .dialogue-avatar {
        width: 45px;
        height: 45px;
        font-size: 1rem;
      }

      .dialogue-info h3 {
        font-size: 1rem;
      }

      .dialogue-info p {
        font-size: 0.8rem;
      }

      .dialogue-messages {
        max-height: 200px;
        padding: 12px;
        margin-bottom: 12px;
      }

      .message-avatar {
        width: 32px;
        height: 32px;
        font-size: 0.75rem;
      }

      .message-bubble {
        padding: 10px 12px;
        font-size: 0.9rem;
      }

      .message-bubble .chinese {
        font-size: 1rem;
      }

      .message-bubble .pinyin {
        font-size: 0.75rem;
      }

      /* 選項按鈕 - 手機版 */
      .reply-options {
        gap: 8px;
      }

      .reply-btn {
        padding: 10px 14px;
        font-size: 0.85rem;
      }

      .complete-stats {
        flex-direction: column;
        gap: 16px;
      }
    }

    @media (max-width: 600px) {
      .market-scene {
        gap: 8px;
      }

      .scene-item {
        padding: 10px 12px;
        min-width: 65px;
      }

      .scene-icon {
        width: 40px;
        height: 40px;
      }

      .scene-icon svg {
        width: 20px;
        height: 20px;
      }

      .intro-tips {
        flex-direction: column;
        align-items: center;
      }

      .stall-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .complete-stats {
        flex-direction: column;
        gap: 16px;
      }
    }

    /* 超小螢幕 (320px) */
    @media (max-width: 320px) {
      main {
        padding: 16px 8px;
      }

      .intro-section {
        padding: 16px 12px;
      }

      .intro-title {
        font-size: 1.5rem;
      }

      .intro-subtitle {
        font-size: 0.875rem;
      }

      .market-scene {
        gap: 6px;
      }

      .scene-item {
        padding: 8px 10px;
        min-width: 55px;
      }

      .scene-icon {
        width: 36px;
        height: 36px;
      }

      .scene-icon svg {
        width: 18px;
        height: 18px;
      }

      .scene-label {
        font-size: 0.6875rem;
      }

      .steps-header {
        font-size: 1rem;
      }

      .intro-step {
        padding: 12px;
        gap: 12px;
      }

      .step-number {
        width: 32px;
        height: 32px;
        font-size: 0.875rem;
      }

      .step-text {
        font-size: 0.85rem;
      }

      .step-desc {
        font-size: 0.75rem;
      }

      .tip-badge {
        padding: 6px 10px;
        font-size: 0.75rem;
      }

      .start-btn {
        padding: 12px 32px;
        font-size: 1rem;
      }

      /* 購物區 */
      .shopping-header, .market-area, .dialogue-area, .checkout-area {
        padding: 12px;
      }

      .shopping-title, .market-title {
        font-size: 1rem;
      }

      .shopping-item {
        padding: 8px 12px;
        font-size: 0.875rem;
      }

      .shopping-item-qty {
        padding: 2px 8px;
        font-size: 0.75rem;
      }

      .stall-item {
        width: 90px;
        padding: 10px;
      }

      .stall-image {
        width: 50px;
        height: 50px;
      }

      .stall-name {
        font-size: 0.75rem;
      }

      .stall-price {
        font-size: 0.6875rem;
        padding: 2px 8px;
      }

      .dialogue-avatar {
        width: 36px;
        height: 36px;
        font-size: 0.875rem;
      }

      .dialogue-info h3 {
        font-size: 0.9375rem;
      }

      .dialogue-messages {
        max-height: 150px;
        padding: 10px;
      }

      .message-avatar {
        width: 28px;
        height: 28px;
        font-size: 0.6875rem;
      }

      .message-bubble {
        padding: 8px 10px;
      }

      .message-text {
        font-size: 0.85rem;
      }

      .message-pinyin {
        font-size: 0.7rem;
      }

      .response-option {
        padding: 12px 14px;
      }

      .response-chinese {
        font-size: 0.9rem;
      }

      .response-pinyin {
        font-size: 0.75rem;
      }

      .checkout-item {
        padding: 10px 12px;
        font-size: 0.875rem;
      }

      .checkout-total {
        padding: 14px 16px;
        font-size: 1.125rem;
      }

      .checkout-total span:last-child {
        font-size: 1.25rem;
      }

      .pay-btn {
        padding: 14px;
        font-size: 1rem;
      }

      /* 完成畫面 */
      .complete-card {
        padding: 32px 16px;
      }

      .complete-icon {
        width: 64px;
        height: 64px;
      }

      .complete-icon svg {
        width: 32px;
        height: 32px;
      }

      .complete-title {
        font-size: 1.5rem;
      }

      .complete-message {
        font-size: 0.9375rem;
      }

      .stat-item {
        padding: 12px 16px;
      }

      .stat-value {
        font-size: 1.75rem;
      }

      .stat-label {
        font-size: 0.75rem;
      }

      .restart-btn {
        padding: 12px 32px;
        font-size: 1rem;
      }
    }

    /* 橫向模式 */
    @media (max-height: 500px) and (orientation: landscape) {
      main {
        padding: 12px 16px;
      }

      .intro-section {
        padding: 16px;
      }

      .intro-title {
        font-size: 1.5rem;
        margin-bottom: 8px;
      }

      .intro-subtitle {
        font-size: 0.875rem;
        margin-bottom: 16px;
      }

      .market-scene {
        margin-bottom: 16px;
        gap: 12px;
      }

      .scene-item {
        padding: 8px 12px;
      }

      .scene-icon {
        width: 32px;
        height: 32px;
      }

      .steps-header {
        font-size: 1rem;
        margin-bottom: 12px;
      }

      .intro-steps {
        gap: 8px;
        max-width: 100%;
      }

      .intro-step {
        padding: 10px 14px;
      }

      .step-number {
        width: 28px;
        height: 28px;
        font-size: 0.8rem;
      }

      .intro-tips {
        margin: 12px 0;
        gap: 8px;
      }

      .start-btn {
        margin-top: 12px;
        padding: 10px 32px;
        font-size: 1rem;
      }

      /* 購物區 */
      .shopping-header {
        padding: 12px;
        margin-bottom: 12px;
      }

      .shopping-title {
        font-size: 1rem;
        margin-bottom: 8px;
      }

      .market-area {
        padding: 12px;
        margin-bottom: 12px;
      }

      .market-title {
        font-size: 0.9375rem;
        margin-bottom: 8px;
      }

      .dialogue-area {
        padding: 12px;
        margin-bottom: 12px;
      }

      .dialogue-header {
        margin-bottom: 8px;
        padding-bottom: 8px;
      }

      .dialogue-messages {
        max-height: 120px;
        margin-bottom: 8px;
      }

      .checkout-area {
        padding: 12px;
      }

      .complete-card {
        padding: 24px;
      }

      .complete-icon {
        width: 48px;
        height: 48px;
        margin-bottom: 12px;
      }

      .complete-title {
        font-size: 1.25rem;
        margin-bottom: 8px;
      }

      .complete-message {
        font-size: 0.875rem;
        margin-bottom: 16px;
      }

      .complete-stats {
        flex-direction: row;
        gap: 16px;
        margin-bottom: 16px;
      }

      .stat-item {
        padding: 8px 16px;
      }

      .stat-value {
        font-size: 1.5rem;
      }
    }
  </style>
</head>
<body>
  <div class="bg-pattern"></div>
  <div class="bg-gradient"></div>
  <div class="roof-deco"></div>

  <header class="nav-header">
    <div class="nav-left">
      <a href="index.html" class="back-btn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="19" y1="12" x2="5" y2="12"/>
          <polyline points="12 19 5 12 12 5"/>
        </svg>
        返回
      </a>
      <h1 class="page-title">模擬市場</h1>
    </div>
  </header>

  <main>
    <!-- 介紹區 -->
    <section class="intro-section" id="intro-section">
      <h1 class="intro-title">模擬市場</h1>
      <p class="intro-subtitle">用金門話完成市場買賣，體驗傳統市場的對話情境</p>

      <!-- 市場情境圖示 -->
      <div class="market-scene">
        <div class="scene-item">
          <div class="scene-icon">
            <svg viewBox="0 0 24 24"><path d="m2 7 4.41-4.41A2 2 0 0 1 7.83 2h8.34a2 2 0 0 1 1.42.59L22 7"/><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><path d="M15 22v-4a2 2 0 0 0-2-2h-2a2 2 0 0 0-2 2v4"/><path d="M2 7h20"/><path d="M22 7v3a2 2 0 0 1-2 2a2.7 2.7 0 0 1-1.59-.63.7.7 0 0 0-.82 0A2.7 2.7 0 0 1 16 12a2.7 2.7 0 0 1-1.59-.63.7.7 0 0 0-.82 0A2.7 2.7 0 0 1 12 12a2.7 2.7 0 0 1-1.59-.63.7.7 0 0 0-.82 0A2.7 2.7 0 0 1 8 12a2.7 2.7 0 0 1-1.59-.63.7.7 0 0 0-.82 0A2.7 2.7 0 0 1 4 12a2 2 0 0 1-2-2V7"/></svg>
          </div>
          <span class="scene-label">傳統市場</span>
        </div>
        <div class="scene-item">
          <div class="scene-icon">
            <svg viewBox="0 0 24 24"><path d="M7 21h10"/><path d="M12 21a9 9 0 0 0 9-9H3a9 9 0 0 0 9 9Z"/><path d="M11.38 12a2.4 2.4 0 0 1-.4-4.77 2.4 2.4 0 0 1 3.2-2.77 2.4 2.4 0 0 1 3.47-.63 2.4 2.4 0 0 1 3.37 3.37 2.4 2.4 0 0 1-1.1 3.7 2.51 2.51 0 0 1 .03 1.1"/><path d="m13 12 4-4"/><path d="M10.9 7.25A2.4 2.4 0 0 0 8 5a2.4 2.4 0 0 0-3 3 2.4 2.4 0 0 0 .47 4.77"/></svg>
          </div>
          <span class="scene-label">新鮮蔬果</span>
        </div>
        <div class="scene-item">
          <div class="scene-icon">
            <svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/><path d="M8 10h.01"/><path d="M12 10h.01"/><path d="M16 10h.01"/></svg>
          </div>
          <span class="scene-label">金門話對話</span>
        </div>
        <div class="scene-item">
          <div class="scene-icon">
            <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M16 8h-6a2 2 0 1 0 0 4h4a2 2 0 1 1 0 4H8"/><path d="M12 18V6"/></svg>
          </div>
          <span class="scene-label">買賣交易</span>
        </div>
      </div>

      <!-- 步驟標題 -->
      <div class="steps-header">活動流程</div>

      <div class="intro-steps">
        <div class="intro-step">
          <div class="step-icon-wrap">
            <span class="step-number">1</span>
            <span class="step-icon">
              <svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M12 8v8"/><path d="m8.5 14 7-4"/><path d="m8.5 10 7 4"/></svg>
            </span>
          </div>
          <div class="step-content">
            <span class="step-text">抽取購買菜單</span>
            <span class="step-desc">各組派代表抽取組內的購買任務清單</span>
          </div>
        </div>
        <div class="intro-step">
          <div class="step-icon-wrap">
            <span class="step-number">2</span>
            <span class="step-icon">
              <svg viewBox="0 0 24 24"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
            </span>
          </div>
          <div class="step-content">
            <span class="step-text">組內討論策略</span>
            <span class="step-desc">分工合作，討論如何用金門話完成購物</span>
          </div>
        </div>
        <div class="intro-step">
          <div class="step-icon-wrap">
            <span class="step-number">3</span>
            <span class="step-icon">
              <svg viewBox="0 0 24 24"><circle cx="8" cy="21" r="1"/><circle cx="19" cy="21" r="1"/><path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"/></svg>
            </span>
          </div>
          <div class="step-content">
            <span class="step-text">用金門話購物</span>
            <span class="step-desc">根據菜單到各攤販買食材，全程使用金門話對話</span>
          </div>
        </div>
        <div class="intro-step">
          <div class="step-icon-wrap">
            <span class="step-number">4</span>
            <span class="step-icon">
              <svg viewBox="0 0 24 24"><path d="m16 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z"/><path d="m2 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z"/><path d="M7 21h10"/><path d="M12 3v18"/><path d="M3 7h2c2 0 5-1 7-2 2 1 5 2 7 2h2"/></svg>
            </span>
          </div>
          <div class="step-content">
            <span class="step-text">老闆秤重收款</span>
            <span class="step-desc">老闆依顧客需求給予正確數量並收取金額</span>
          </div>
        </div>
        <div class="intro-step">
          <div class="step-icon-wrap">
            <span class="step-number">5</span>
            <span class="step-icon">
              <svg viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
            </span>
          </div>
          <div class="step-content">
            <span class="step-text">完成檢查</span>
            <span class="step-desc">將購買物品及菜單放於桌上進行核對</span>
          </div>
        </div>
      </div>

      <!-- 提示標籤 -->
      <div class="intro-tips">
        <div class="tip-badge">
          <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>
          <span>練習數量表達</span>
        </div>
        <div class="tip-badge">
          <svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
          <span>學習買賣對話</span>
        </div>
        <div class="tip-badge">
          <svg viewBox="0 0 24 24"><rect x="6" y="11" width="12" height="10" rx="2"/><path d="M12 11V6a2 2 0 0 0-2-2H6"/><path d="m4 10 2-4h12l2 4"/><path d="M12 15v4"/></svg>
          <span>互動遊戲體驗</span>
        </div>
      </div>

      <button class="start-btn" id="start-btn">開始購物</button>
    </section>

    <!-- 購物區 -->
    <section class="shopping-section" id="shopping-section">
      <!-- 購物清單 -->
      <div class="shopping-header">
        <h2 class="shopping-title">今日購物清單</h2>
        <div class="shopping-list" id="shopping-list"></div>
      </div>

      <!-- 市場攤位 -->
      <div class="market-area">
        <h3 class="market-title">市場攤位 - 點選要購買的蔬果</h3>
        <div class="stall-grid" id="stall-grid"></div>
      </div>

      <!-- 對話區 -->
      <div class="dialogue-area" id="dialogue-area">
        <div class="dialogue-header">
          <div class="dialogue-avatar">賣</div>
          <div class="dialogue-info">
            <h3>頭家</h3>
            <p id="current-item-name">正在購買：苦瓜</p>
          </div>
        </div>

        <div class="dialogue-messages" id="dialogue-messages"></div>

        <div class="response-options" id="response-options"></div>
      </div>

      <!-- 結帳區 -->
      <div class="checkout-area" id="checkout-area">
        <h3 class="checkout-title">結帳明細</h3>
        <div class="checkout-items" id="checkout-items"></div>
        <div class="checkout-total">
          <span>總計</span>
          <span id="checkout-total-price">0 箍</span>
        </div>
        <button class="pay-btn" id="pay-btn">付款完成</button>
      </div>
    </section>

    <!-- 完成畫面 -->
    <section class="complete-section" id="complete-section" style="display:none">
      <div class="complete-card">
        <div class="complete-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="20 6 9 17 4 12"/>
          </svg>
        </div>
        <h2 class="complete-title">購物完成！</h2>
        <p class="complete-message">你已經成功用金門話完成市場購物！</p>

        <div class="complete-stats">
          <div class="stat-item">
            <div class="stat-value" id="stat-items">0</div>
            <div class="stat-label">購買項目</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="stat-total">0</div>
            <div class="stat-label">總金額（箍）</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="stat-dialogues">0</div>
            <div class="stat-label">對話次數</div>
          </div>
        </div>

        <button class="restart-btn" id="restart-btn">再玩一次</button>
      </div>
    </section>
  </main>

  <script type="module">
    let vocabulary = [];
    let dialogues = [];
    let shoppingList = [];
    let cart = [];
    let currentItem = null;
    let dialogueCount = 0;

    // 初始化
    async function init() {
      try {
        const [vocabRes, dialogueRes] = await Promise.all([
          fetch('data/vocabulary.json'),
          fetch('data/dialogues.json')
        ]);

        const vocabData = await vocabRes.json();
        const dialogueData = await dialogueRes.json();

        vocabulary = vocabData.vocabulary;
        dialogues = dialogueData;

        setupEventListeners();
      } catch (error) {
        console.error('載入失敗:', error);
      }
    }

    function setupEventListeners() {
      document.getElementById('start-btn').addEventListener('click', startShopping);
      document.getElementById('pay-btn').addEventListener('click', completeShopping);
      document.getElementById('restart-btn').addEventListener('click', restart);
    }

    // 開始購物
    function startShopping() {
      // 隱藏介紹，顯示購物區
      document.getElementById('intro-section').style.display = 'none';
      document.getElementById('shopping-section').classList.add('active');

      // 生成購物清單（3-5 個項目）
      const shuffled = [...vocabulary].sort(() => Math.random() - 0.5);
      const count = 3 + Math.floor(Math.random() * 3);
      shoppingList = shuffled.slice(0, count).map(item => ({
        ...item,
        quantity: 1 + Math.floor(Math.random() * 3),
        price: (Math.floor(Math.random() * 10) + 3) * 10,
        bought: false
      }));

      cart = [];
      dialogueCount = 0;

      renderShoppingList();
      renderStalls();
    }

    // 渲染購物清單
    function renderShoppingList() {
      const container = document.getElementById('shopping-list');
      container.innerHTML = '';

      shoppingList.forEach(item => {
        const el = document.createElement('div');
        el.className = `shopping-item ${item.bought ? 'bought' : ''}`;
        el.innerHTML = `
          <span>${item.chinese}</span>
          <span class="shopping-item-qty">${item.quantity} 斤</span>
        `;
        container.appendChild(el);
      });
    }

    // 渲染攤位
    function renderStalls() {
      const container = document.getElementById('stall-grid');
      container.innerHTML = '';

      // 顯示購物清單上的項目 + 一些干擾項
      const displayItems = [...shoppingList];
      const others = vocabulary.filter(v => !shoppingList.find(s => s.id === v.id));
      const shuffledOthers = others.sort(() => Math.random() - 0.5).slice(0, 4);

      const allItems = [...displayItems, ...shuffledOthers.map(item => ({
        ...item,
        quantity: 0,
        price: (Math.floor(Math.random() * 10) + 3) * 10,
        bought: false,
        isExtra: true
      }))].sort(() => Math.random() - 0.5);

      allItems.forEach(item => {
        const el = document.createElement('div');
        el.className = 'stall-item';
        el.innerHTML = `
          <div class="stall-image">
            <img src="${item.image}" alt="${item.chinese}" onerror="this.parentElement.textContent='&#127822;'">
          </div>
          <div class="stall-name">${item.chinese}</div>
          <div class="stall-price">一斤 ${item.price} 箍</div>
        `;

        el.addEventListener('click', () => selectItem(item));
        container.appendChild(el);
      });
    }

    // 選擇商品
    function selectItem(item) {
      // 檢查是否在購物清單上且尚未購買
      const listItem = shoppingList.find(s => s.id === item.id && !s.bought);

      if (!listItem) {
        // 不在清單上或已購買
        alert('這個不在今天的購物清單上喔！');
        return;
      }

      currentItem = listItem;
      document.getElementById('current-item-name').textContent = `正在購買：${item.chinese}`;

      // 顯示對話區
      const dialogueArea = document.getElementById('dialogue-area');
      dialogueArea.classList.add('active');
      document.getElementById('checkout-area').classList.remove('active');

      // 自動滾動到對話區
      setTimeout(() => {
        dialogueArea.scrollIntoView({ behavior: 'smooth', block: 'start' });
        // 再次滾動確保回應選項也能看到
        setTimeout(() => {
          const responseOpts = document.getElementById('response-options');
          if (responseOpts.children.length > 0) {
            responseOpts.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
          }
        }, 500);
      }, 100);

      // 開始對話
      startDialogue(listItem);
    }

    // 開始對話
    function startDialogue(item) {
      const messagesEl = document.getElementById('dialogue-messages');
      messagesEl.innerHTML = '';

      // 頭家開場
      addMessage('vendor', `欲買啥貨？`, `berh bé siánn-huè?`);

      // 顯示回應選項
      showResponseOptions([
        {
          chinese: `我欲買${item.chinese}`,
          pinyin: `guá berh bé ${item.pinyin}`,
          action: () => continueDialogue(item, 'ask_quantity')
        },
        {
          chinese: `${item.chinese}一斤佗濟錢？`,
          pinyin: `${item.pinyin} tsit-kun tuā-tsē-tsînn?`,
          action: () => continueDialogue(item, 'ask_price')
        }
      ]);
    }

    // 繼續對話
    function continueDialogue(item, stage) {
      dialogueCount++;

      if (stage === 'ask_quantity') {
        addMessage('customer', `我欲買${item.chinese}`, `guá berh bé ${item.pinyin}`);

        setTimeout(() => {
          addMessage('vendor', `欲幾斤？`, `berh kuí-kun?`);

          showResponseOptions([
            {
              chinese: `我欲買${item.quantity}斤`,
              pinyin: `guá berh bé ${numberToPinyin(item.quantity)}-kun`,
              action: () => continueDialogue(item, 'confirm')
            }
          ]);
        }, 800);

      } else if (stage === 'ask_price') {
        addMessage('customer', `${item.chinese}一斤佗濟錢？`, `${item.pinyin} tsit-kun tuā-tsē-tsînn?`);

        setTimeout(() => {
          addMessage('vendor', `一斤${item.price}箍，誠新鮮！`, `tsit-kun ${numberToPinyin(item.price)}-khoo, tsiânn sin-sian!`);

          showResponseOptions([
            {
              chinese: `好，我欲買${item.quantity}斤`,
              pinyin: `hó, guá berh bé ${numberToPinyin(item.quantity)}-kun`,
              action: () => continueDialogue(item, 'confirm')
            },
            {
              chinese: `會使算我較俗無？`,
              pinyin: `ē-sái sǹg guá khah-sio̍k bô?`,
              action: () => continueDialogue(item, 'bargain')
            }
          ]);
        }, 800);

      } else if (stage === 'bargain') {
        addMessage('customer', `會使算我較俗無？`, `ē-sái sǹg guá khah-sio̍k bô?`);

        setTimeout(() => {
          const discount = Math.random() > 0.5;
          if (discount) {
            item.price = Math.max(20, item.price - 10);
            addMessage('vendor', `好啦，算你${item.price}箍就好`, `hó lah, sǹg lí ${numberToPinyin(item.price)}-khoo tō hó`);
          } else {
            addMessage('vendor', `無法度較俗啦，這已經誠便宜了`, `bô-huat-tōo khah-sio̍k lah`);
          }

          showResponseOptions([
            {
              chinese: `好，我欲買${item.quantity}斤`,
              pinyin: `hó, guá berh bé ${numberToPinyin(item.quantity)}-kun`,
              action: () => continueDialogue(item, 'confirm')
            }
          ]);
        }, 800);

      } else if (stage === 'confirm') {
        addMessage('customer', `好，我欲買${item.quantity}斤`, `hó, guá berh bé ${numberToPinyin(item.quantity)}-kun`);

        const total = item.quantity * item.price;

        setTimeout(() => {
          addMessage('vendor', `${item.quantity}斤，總共${total}箍`, `${numberToPinyin(item.quantity)}-kun, tsóng-kiōng ${numberToPinyin(total)}-khoo`);

          showResponseOptions([
            {
              chinese: `好，多謝！`,
              pinyin: `hó, to-siā!`,
              action: () => completePurchase(item)
            }
          ]);
        }, 800);
      }
    }

    // 完成單項購買
    function completePurchase(item) {
      addMessage('customer', `好，多謝！`, `hó, to-siā!`);

      setTimeout(() => {
        addMessage('vendor', `多謝！歡迎再來！`, `to-siā! huan-gîng tsài-lâi!`);

        // 標記為已購買
        item.bought = true;
        cart.push({
          name: item.chinese,
          quantity: item.quantity,
          price: item.price,
          total: item.quantity * item.price
        });

        renderShoppingList();

        // 檢查是否全部買完
        setTimeout(() => {
          document.getElementById('dialogue-area').classList.remove('active');

          if (shoppingList.every(s => s.bought)) {
            showCheckout();
          } else {
            // 滾動回攤位區繼續選購
            setTimeout(() => {
              document.querySelector('.market-area').scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
          }
        }, 1000);
      }, 800);
    }

    // 添加對話訊息
    function addMessage(role, chinese, pinyin) {
      const messagesEl = document.getElementById('dialogue-messages');

      const el = document.createElement('div');
      el.className = `message ${role}`;
      el.innerHTML = `
        <div class="message-avatar">${role === 'vendor' ? '賣' : '客'}</div>
        <div class="message-content">
          <div class="message-bubble">
            <div class="message-text">${chinese}</div>
            <div class="message-pinyin">${pinyin}</div>
          </div>
        </div>
      `;

      messagesEl.appendChild(el);
      messagesEl.scrollTop = messagesEl.scrollHeight;

      // 確保最新訊息在畫面中可見
      setTimeout(() => {
        messagesEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }, 50);
    }

    // 顯示回應選項
    function showResponseOptions(options) {
      const container = document.getElementById('response-options');
      container.innerHTML = '';

      options.forEach(opt => {
        const btn = document.createElement('button');
        btn.className = 'response-option';
        btn.innerHTML = `
          <div class="response-chinese">${opt.chinese}</div>
          <div class="response-pinyin">${opt.pinyin}</div>
        `;
        btn.addEventListener('click', () => {
          container.innerHTML = '';
          opt.action();
        });
        container.appendChild(btn);
      });

      // 確保回應選項可見
      setTimeout(() => {
        container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }, 150);
    }

    // 數字轉拼音
    function numberToPinyin(num) {
      const digits = ['khòng', 'tsit', 'nn̄g', 'sann', 'sì', 'gōo', 'la̍k', 'tshit', 'pueh', 'káu', 'tsa̍p'];

      if (num <= 10) return digits[num];
      if (num < 20) return `tsa̍p-${digits[num - 10]}`;
      if (num < 100) {
        const tens = Math.floor(num / 10);
        const ones = num % 10;
        if (ones === 0) return `${digits[tens]}-tsa̍p`;
        return `${digits[tens]}-tsa̍p-${digits[ones]}`;
      }
      if (num === 100) return 'tsit-pah';
      return num.toString();
    }

    // 顯示結帳
    function showCheckout() {
      const checkoutArea = document.getElementById('checkout-area');
      checkoutArea.classList.add('active');

      const itemsEl = document.getElementById('checkout-items');
      itemsEl.innerHTML = '';

      let grandTotal = 0;

      cart.forEach(item => {
        const el = document.createElement('div');
        el.className = 'checkout-item';
        el.innerHTML = `
          <span>${item.name} x ${item.quantity}斤</span>
          <span>${item.total} 箍</span>
        `;
        itemsEl.appendChild(el);
        grandTotal += item.total;
      });

      document.getElementById('checkout-total-price').textContent = `${grandTotal} 箍`;

      // 自動滾動到結帳區
      setTimeout(() => {
        checkoutArea.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }, 100);
    }

    // 完成購物
    function completeShopping() {
      document.getElementById('shopping-section').classList.remove('active');
      const completeEl = document.getElementById('complete-section');
      completeEl.style.display = 'flex';
      completeEl.classList.add('active');

      const grandTotal = cart.reduce((sum, item) => sum + item.total, 0);

      document.getElementById('stat-items').textContent = cart.length;
      document.getElementById('stat-total').textContent = grandTotal;
      document.getElementById('stat-dialogues').textContent = dialogueCount;
    }

    // 重新開始
    function restart() {
      document.getElementById('complete-section').style.display = 'none';
      document.getElementById('complete-section').classList.remove('active');
      document.getElementById('shopping-section').classList.remove('active');
      document.getElementById('intro-section').style.display = 'block';
      document.getElementById('dialogue-area').classList.remove('active');
      document.getElementById('checkout-area').classList.remove('active');
    }

    // 初始化
    init();
  </script>
</body>
</html>
